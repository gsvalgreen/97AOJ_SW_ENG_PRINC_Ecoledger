version: "3.9"

name: ecoledger-fullstack

services:
  zookeeper:
    image: confluentinc/cp-zookeeper:7.6.1
    container_name: ecoledger-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "22181:2181"
    networks:
      - ecoledger

  kafka:
    image: confluentinc/cp-kafka:7.6.1
    container_name: ecoledger-kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:29092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,PLAINTEXT_HOST://0.0.0.0:29092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 100
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    networks:
      - ecoledger

  schema-registry:
    image: confluentinc/cp-schema-registry:7.6.1
    container_name: ecoledger-schema-registry
    depends_on:
      - kafka
    ports:
      - "8081:8081"
    environment:
      SCHEMA_REGISTRY_HOST_NAME: schema-registry
      SCHEMA_REGISTRY_KAFKASTORE_BOOTSTRAP_SERVERS: PLAINTEXT://kafka:9092
      SCHEMA_REGISTRY_LISTENERS: http://0.0.0.0:8081
    networks:
      - ecoledger

  kafka-ui:
    image: ghcr.io/kafbat/kafka-ui:latest
    container_name: ecoledger-kafka-ui
    depends_on:
      - kafka
      - schema-registry
    ports:
      - "8090:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: ecoledger
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092
      KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:2181
      KAFKA_CLUSTERS_0_SCHEMAREGISTRY: http://schema-registry:8081
    networks:
      - ecoledger

  kafka-init:
    image: confluentinc/cp-kafka:7.6.1
    container_name: ecoledger-kafka-init
    depends_on:
      - kafka
    entrypoint: ["/bin/bash", "-c"]
    command: >-
      "sleep 5 &&
      kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic usuarios.events --partitions 3 --replication-factor 1 &&
      kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic movimentacao.criada --partitions 3 --replication-factor 1 &&
      kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic movimentacao.atualizada --partitions 3 --replication-factor 1 &&
      kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic auditoria.concluida --partitions 3 --replication-factor 1 &&
      kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic certificacao.events --partitions 3 --replication-factor 1 &&
      kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic credito.events --partitions 3 --replication-factor 1 &&
      kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic notificacao.events --partitions 3 --replication-factor 1"
    networks:
      - ecoledger

  minio:
    image: minio/minio:RELEASE.2024-05-10T01-41-38Z
    container_name: ecoledger-minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio-data:/data
    networks:
      - ecoledger

  minio-setup:
    image: minio/mc:latest
    container_name: ecoledger-minio-setup
    depends_on:
      - minio
    entrypoint: ["/bin/sh", "-c"]
    command: >-
      "sleep 5 &&
      mc alias set ecoledger http://minio:9000 minioadmin minioadmin &&
      mc mb -p ecoledger/movimentacoes &&
      mc mb -p ecoledger/anexos &&
      mc anonymous set public ecoledger/anexos"
    networks:
      - ecoledger

  postgres:
    image: postgres:16
    container_name: ecoledger-postgres
    environment:
      POSTGRES_USER: ecoledger_admin
      POSTGRES_PASSWORD: ecoledger_admin
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./docker/postgres-init:/docker-entrypoint-initdb.d:ro
    networks:
      - ecoledger

  mailhog:
    image: mailhog/mailhog:v1.0.1
    container_name: ecoledger-mailhog
    ports:
      - "1025:1025"
      - "8025:8025"
    networks:
      - ecoledger

  # WireMock used for auxiliary stubs (e.g. notificacoes, preferencias)
  wiremock:
    image: wiremock/wiremock:3.13.2
    container_name: wiremock-producer
    command: ["--local-response-templating","--verbose"]
    ports:
      - "8089:8080"
    volumes:
      - ./movimentacao-service/wiremock/producer:/home/wiremock
    networks:
      - ecoledger

  # Movimentacao service built locally
  movimentacao-service:
    build:
      context: ./movimentacao-service
      dockerfile: Dockerfile
    image: movimentacao-service:local
    container_name: ecoledger-movimentacao-service
    depends_on:
      - postgres
      - kafka
      - minio
      - schema-registry
    ports:
      - "8082:8080"
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/movimentacao
      SPRING_DATASOURCE_USERNAME: ecoledger_movimentacao
      SPRING_DATASOURCE_PASSWORD: ecoledger_movimentacao
      KAFKA_BOOTSTRAP: kafka:9092
      S3_ENDPOINT: http://minio:9000
      S3_BUCKET: movimentacoes
      S3_REGION: sa-east-1
      S3_ACCESS_KEY: minioadmin
      S3_SECRET_KEY: minioadmin
      S3_PUBLIC_BASE_URL: http://minio:9000/movimentacoes
      S3_USE_PATH_STYLE: "true"
      MOVIMENTACAO_KAFKA_ENABLED: "true"
      MOVIMENTACAO_S3_LENIENT_WHEN_MISSING: "true"
      PRODUCER_APPROVAL_BASE_URL: http://users-service:8080
      PRODUCER_APPROVAL_AUTH_TOKEN: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJtb3ZpbWVudGFjYW8tc2VydmljZSIsInNjb3BlcyI6InVzdWFyaW9zOnJlYWQiLCJpYXQiOjE3NjU3NjI1MzAsImV4cCI6MTkyMzQ0MjUzMH0.6VsmHz5xVNJiHFo3tQeuJSvCW7K9zlvutFvs-O0I-N0
    networks:
      - ecoledger

  # Auditoria service built locally
  auditoria-service:
    build:
      context: ./auditoria-service
      dockerfile: Dockerfile
    image: auditoria-service:local
    container_name: ecoledger-auditoria-service
    depends_on:
      - postgres
      - kafka
      - kafka-init
    ports:
      - "8083:8082"
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/auditoria
      SPRING_DATASOURCE_USERNAME: ecoledger_auditoria
      SPRING_DATASOURCE_PASSWORD: ecoledger_auditoria
      KAFKA_ENABLED: "true"
      KAFKA_BOOTSTRAP: kafka:9092
      AUDIT_RULES_PATH: /app/rules
      MAX_RETRIES: "5"
    volumes:
      - ./auditoria-service/rules:/app/rules:ro
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8082/actuator/health"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3
    networks:
      - ecoledger

  users-service:
    build:
      context: ./users-service
      dockerfile: Dockerfile
    image: users-service:local
    container_name: ecoledger-users-service
    depends_on:
      - postgres
      - kafka
      - kafka-init
    ports:
      - "8084:8080"
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/users
      SPRING_DATASOURCE_USERNAME: ecoledger_users
      SPRING_DATASOURCE_PASSWORD: ecoledger_users
      KAFKA_BOOTSTRAP: kafka:9092
      NOTIFY_ENDPOINT: http://wiremock:8080/notificacoes/enviar
      JWT_SECRET: ecoledger-secret-key-minimum-256-bits-for-hs256-algorithm-security
    networks:
      - ecoledger

  certificacao-service:
    build:
      context: ./certificacao-service
      dockerfile: Dockerfile
    image: certificacao-service:local
    container_name: ecoledger-certificacao-service
    depends_on:
      - postgres
      - kafka
      - kafka-init
    ports:
      - "8085:8085"
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/certificacao
      SPRING_DATASOURCE_USERNAME: ecoledger_certificacao
      SPRING_DATASOURCE_PASSWORD: ecoledger_certificacao
      KAFKA_ENABLED: "true"
      KAFKA_BOOTSTRAP: kafka:9092
      SELO_EXPIRATION_DIAS: 180
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8085/actuator/health"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3
    networks:
      - ecoledger

  # Frontend web application
  # frontend-web:
  #   build:
  #     context: ./frontend-web
  #     dockerfile: Dockerfile
  #   image: frontend-web:local
  #   container_name: ecoledger-frontend-web
  #   depends_on:
  #     movimentacao-service:
  #       condition: service_started
  #     auditoria-service:
  #       condition: service_healthy
  #     users-service:
  #       condition: service_started
  #     certificacao-service:
  #       condition: service_healthy
  #   ports:
  #     - "3000:80"
  #   environment:
  #     # Frontend will be built with VITE_MOCK_API=true (set in Dockerfile)
  #     # In production, you would configure API endpoints here
  #     NODE_ENV: production
  #   networks:
  #     - ecoledger

  # Frontend v2 - Modern React application
  frontend-v2:
    build:
      context: ./frontend-v2
      dockerfile: Dockerfile
    image: frontend-v2:local
    container_name: ecoledger-frontend-v2
    depends_on:
      movimentacao-service:
        condition: service_started
      auditoria-service:
        condition: service_healthy
      users-service:
        condition: service_started
      certificacao-service:
        condition: service_healthy
      postgres:
        condition: service_started
      kafka:
        condition: service_started
    ports:
      - "3000:80"
    environment:
      NODE_ENV: production
      # API endpoints are configured in nginx.conf
    networks:
      - ecoledger
    restart: unless-stopped

networks:
  ecoledger:
    driver: bridge

volumes:
  postgres-data:
  minio-data:
